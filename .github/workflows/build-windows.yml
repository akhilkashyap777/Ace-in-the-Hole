name: Build Windows Nuitka Executable
on:
  push:
    branches: [ android-removed ]
  pull_request:
    branches: [ android-removed ]
  workflow_dispatch:

jobs:
  build-windows-nuitka:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nuitka
          pip install kivy
          pip install kivy-deps.angle
          pip install kivy-deps.sdl2
          pip install kivy-deps.glew
          pip install kivymd
          pip install pillow
          pip install requests
          pip install qrcode
          pip install bcrypt
          pip install cryptography
          pip install pygame
          pip install plyer
          pip install opencv-python
          pip install openpyxl
          pip install docx2txt
          pip install mutagen
          pip install imageio
          pip install imageio_ffmpeg
          pip install psutil
          
      - name: Set OpenGL Backend Environment
        run: |
          $env:KIVY_GL_BACKEND = "angle_sdl2"
          
      - name: Build with Nuitka
        env:
          KIVY_GL_BACKEND: angle_sdl2
        run: |
          python -m nuitka `
          --standalone `
          --assume-yes-for-downloads `
          --windows-disable-console `
          --output-filename=AceInTheHole-Windows.exe `
          --include-package=kivymd `
          --include-package=kivy `
          --include-package=PIL `
          --include-package=requests `
          --include-package=qrcode `
          --include-package=bcrypt `
          --include-package=cryptography `
          --include-package=pygame `
          --include-package=plyer `
          --include-package=cv2 `
          --include-package=openpyxl `
          --include-package=docx2txt `
          --include-package=mutagen `
          --include-package=imageio `
          --include-package=psutil `
          --include-package=tkinter `
          main.py
          
      - name: Verify build
        run: |
          if (Test-Path "main.exe") {
              $size = (Get-Item "main.exe").Length / 1MB
              Write-Host "Executable created successfully!"
              Write-Host "Size: $([math]::Round($size, 2)) MB"
              Rename-Item "main.exe" "AceInTheHole-Windows.exe"
          } else {
              Write-Host "Error: Executable not found!"
              Get-ChildItem -Name
              exit 1
          }
          
      - name: Upload Nuitka executable
        uses: actions/upload-artifact@v4
        with:
          name: AceInTheHole-Nuitka-Executable
          path: AceInTheHole-Windows.exe
          retention-days: 30
