name: ๐ค Build Android APK
on:
ย push:
ย ย branches: [ imports-removed ]
ย pull_request:
ย ย branches: [ imports-removed ]
ย workflow_dispatch:

jobs:
ย build-android:
ย ย runs-on: ubuntu-latest
ย ย steps:
ย ย - name: ๐ฅ Checkout code
ย ย ย uses: actions/checkout@v4

ย ย - name: ๐ Set up Python
ย ย ย uses: actions/setup-python@v4
ย ย ย with:
ย ย ย ย python-version: '3.10'

ย ย - name: โ Set up JDK 17
ย ย ย uses: actions/setup-java@v3
ย ย ย with:
ย ย ย ย java-version: '17'
ย ย ย ย distribution: 'temurin'

ย ย - name: ๐ง Install system dependencies
ย ย ย run: |
ย ย ย ย sudo apt update
ย ย ย ย sudo apt install -y git zip unzip python3-pip autoconf libtool pkg-config \
ย ย ย ย ย zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo6 cmake libffi-dev \
ย ย ย ย ย libssl-dev automake libltdl-dev

ย ย - name: ๐ฆ Install Python dependencies (Including p4a)
ย ย ย run: |
ย ย ย ย pip install --user --upgrade pip
ย ย ย ย pip install --user --upgrade Cython==0.29.36 virtualenv
ย ย ย ย pip install --user --upgrade buildozer==1.5.0
ย ย ย ย pip install --user --upgrade python-for-android==2021.9.5

ย ย - name: ๐ค Setup Android SDK manually
ย ย ย run: |
ย ย ย ย # Set environment variables
ย ย ย ย export ANDROID_SDK_ROOT=$HOME/android-sdk
ย ย ย ย export ANDROID_HOME=$HOME/android-sdk
ย ย ย ย export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools
ย ย ย ย echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
ย ย ย ย echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
ย ย ย ย echo "PATH=$PATH:$HOME/android-sdk/cmdline-tools/latest/bin:$HOME/android-sdk/platform-tools" >> $GITHUB_ENV
ย ย ย ย # Create SDK directory
ย ย ย ย mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
ย ย ย ย # Download and install command line tools
ย ย ย ย wget -q https://dl.google.com/android/repository/commandlinetools-linux-8512546_latest.zip -O cmdline-tools.zip
ย ย ย ย unzip -q cmdline-tools.zip -d cmdline-tools-temp
ย ย ย ย mv cmdline-tools-temp/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
ย ย ย ย rm -rf cmdline-tools.zip cmdline-tools-temp
ย ย ย ย # Make sdkmanager executable
ย ย ย ย chmod +x $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager
ย ย ย ย # Accept licenses and install packages
ย ย ย ย yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
ย ย ย ย yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools"
ย ย ย ย yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platforms;android-33"
ย ย ย ย yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;33.0.0"
ย ย ย ย yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "ndk;23.1.7779620"
ย ย ย ย # Verify AIDL is installed
ย ย ย ย echo "๐ Checking for AIDL..."
ย ย ย ย find $ANDROID_SDK_ROOT -name "aidl" -type f || echo "AIDL not found yet"
ย ย ย ย ls -la $ANDROID_SDK_ROOT/build-tools/33.0.0/ || echo "Build tools directory not found"


ย ย - name: ๐งน Remove old buildozer cache
ย ย ย run: |
ย ย ย ย rm -rf .buildozer
ย ย ย ย rm -rf bin

ย ย - name: ๐ Show project files and environment
ย ย ย run: |
ย ย ย ย echo "๐ Python files in project:"
ย ย ย ย ls -la *.py
ย ย ย ย echo ""
ย ย ย ย echo "๐ง Environment variables:"
ย ย ย ย echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
ย ย ย ย echo "ANDROID_HOME: $ANDROID_HOME"
ย ย ย ย echo "JAVA_HOME: $JAVA_HOME"
ย ย ย ย echo ""
ย ย ย ย echo "๐ buildozer.spec content:"
ย ย ย ย cat buildozer.spec

ย ย - name: ๐๏ธ Initialize Buildozer
ย ย ย run: |
ย ย ย ย export PATH=$PATH:~/.local/bin/
ย ย ย ย buildozer init || echo "Already initialized"
ย ย ย ย buildozer --version

ย ย - name: ๐๏ธ Build Android APK
ย ย ย env:
ย ย ย ย CYTHONIZE_OPTIONS: "language_level=3"
ย ย ย run: |
ย ย ย ย export PATH=$PATH:~/.local/bin/
ย ย ย ย buildozer android debug

ย ย - name: ๐ Verify APK contents
ย ย ย run: |
ย ย ย ย echo "๐ฆ Generated APK files:"
ย ย ย ย find . -name "*.apk" -type f -exec ls -lh {} \;
ย ย ย ย echo ""
ย ย ย ย echo "๐ Checking Python files in APK:"
ย ย ย ย if [ -f bin/*.apk ]; then
ย ย ย ย ย unzip -l bin/*.apk | grep -E "\.(py|pyc)$" | head -20 || echo "No Python files found in APK!"
ย ย ย ย fi

ย ย - name: ๐ค Upload APK
ย ย ย uses: actions/upload-artifact@v4
ย ย ย with:
ย ย ย ย name: MonteCard-Android-APK-${{ github.sha }}
ย ย ย ย path: bin/*.apk
ย ย ย ย retention-days: 30
